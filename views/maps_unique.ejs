<!DOCTYPE html>
<html lang="en">
  <head>
    <% include ./partials/_header.ejs %>
    <title>Map Details | MySpot</title>

    <link rel="stylesheet" href="/vendor/normalize-4.1.1.css" type="text/css" />
    <link rel="stylesheet" href="/vendor/border-box.css" type="text/css" />
    <link rel="stylesheet" href="/styles/layout.css" type="text/css" />

    <script type="text/javascript" src="/vendor/jquery-3.0.0.js"></script>
    <script type="text/javascript" src="/scripts/app.js"></script>

  </head>

  <body>
    <h1>Map Details</h1>

    <% for (var ourMap of mapInfo) { %>
            <h2>Map Name: <%= ourMap.map_name %></h2>
            <% var latitude = ourMap.map_lat %>
            <% var longitude = ourMap.map_long %>

         <% } %>
    <div id="floating-panel">
      <input id="address" type="textbox" value="Sydney, NSW">
      <input id="submit" type="button" value="Geocode">
    </div>
    <div id="map"></div>

    <script>

      function storePoint(latlong){
         let lat = latlong.lat();
         let lng = latlong.lng();

         let data = {
                    lat: lat,
                    lng: lng,
                    id: <%=ourMap.id %>
                    };
                    console.log(data);
         $.ajax({
            type: "POST",
            url: '/points',
            data: data
            })
            .done(function() {
              alert( "success!" );
              })
            .fail(function() {
              alert( "error" );
              })
      }

      function initMap() {
         var map;
         var marker;
      //initiate overall map
        map = new google.maps.Map(document.getElementById('map'), {
         center: {lat: <%= latitude %>,lng: <%= longitude %>},
         zoom: 12
       });
       //loop through points info to add all existing markers
        <% for (var ourPoint of pointInfo) { %>
            marker = new google.maps.Marker({
              position: {lat: <%= ourPoint.point_lat %>, lng: <%= ourPoint.point_long %> },
              map: map,
              title: '<%= ourPoint.point_name %>'
            });
        <% } %>
        //user is able to enter address to create new marker
        var geocoder = new google.maps.Geocoder();

        document.getElementById('submit').addEventListener('click', function() {
          geocodeAddress(geocoder, map);
        });
      };
      //if address exists, add marker to map
      function geocodeAddress(geocoder, resultsMap) {
        var address = document.getElementById('address').value;
        geocoder.geocode({'address': address}, function(results, status) {
          if (status === 'OK') {
            storePoint(results[0].geometry.location);
            resultsMap.setCenter(results[0].geometry.location);
            var marker = new google.maps.Marker({
              map: resultsMap,
              position: results[0].geometry.location
            });
          } else {
            alert('Geocode was not successful for the following reason: ' + status);
          }
        });
      }//end of geocodeAdress function

    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDxv_lcD-DJGOKruhMUYLFKU_LPzP1z8bQ&callback=initMap"></script>


    <p>Here is the map for a specific ID so you can see all the points and map info. YAY! ANYONE CAN SEE THIS PART</p>

    <h3>ONLY FOR AUTH USERS</h3>
    <p>Users can favorite this map by clicking on an icon. that will make this a Fav in the db for the authenticated user. </p>
    <p>This will have options to:
      <ul>
        <li>edit map name</li>
        <li>edit map location</li>
        <li>add Map Points. Points will have Title - Desription - Image</li>
        <li>edit Map Points</li>
        <li>delete Map Points</li>
      </ul>
    </p>
  </body>
</html>
